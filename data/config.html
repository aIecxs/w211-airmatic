<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AIRmatic level custom offset</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background: #f0f0f0;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
    }

    h1 {
      font-size: 56px;
      margin-bottom: 1em;
      text-align: left;
    }

    h2 {
      font-size: 32px;
      margin-top: 2em;
      text-align: left;
    }

    iframe {
      width: 835px;
      height: 359px;
      border: none;
      display: block;
      margin: 1rem auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 808px;
      text-align: center;
    }

    td {
      border: 1px solid #ccc;
      padding: 10px;
    }

    .level-table td {
      font-size: 2em;
    }

    .offset-table .input-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1em;
    }

    .offset-table input[type="number"] {
      width: 100px;
      font-size: 2.5em;
      text-align: center;
    }

    .offset-table .unit {
      font-size: 2.5em;
    }

    .calibration-block {
      width: 100%;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .calibration-block h2 {
      max-width: 808px;
      width: 100%;
      text-align: left;
    }

    .calibration-block table {
      width: 100%;
      max-width: 808px;
      margin: 1em 0;
      align-items: center;
      justify-content: center;
    }

    .calibration-block td {
      padding-left: 20px;
      padding-right: 20px;
    }

    .calibration-block tr:first-child td,
    .calibration-block tr:last-child td {
      background-color: #f8f8f8;
      font-size: 1.5em;
      font-weight: bold;
    }

    .calibration-block input[type="number"] {
      font-size: 2.5em;
      width: 2.5em;
      text-align: center;
    }

    .calibration-control {
      display: flex;
      align-items: center;
      justify-content: space-around;
      width: 100%;
    }
    
    .button-row {
      display: flex;
      justify-content: flex-start;
      gap: 1em;
      width: 808px;
    }

    button {
      font-size: 2em;
      margin-right: 0.3em;
      margin-left: 0.3em;
      width: 180px;
      height: 60px;
    }

    .offset-btn {
      font-size: 1em;
      margin-left: 10px;
    }

    .calibration-control button {
      font-size: 2em;
      width: 1.7em;
      height: 1.7em;
      padding: 0;
      cursor: pointer;
      user-select: none;
    }

    .mode-block {
      margin-bottom: 3em;
    }

    .mode-image {
      display: block;
      width: 100%;
      max-width: 808px;
      aspect-ratio: 808 / 316;
      border: 1px solid #ccc;
      margin-bottom: 1em;
    }

    .cell-with-slider {
      position: relative;
      height: 50px;
    }

    .cell-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .cell-wrapper input[type=range].reversed {
      transform: translate(-50%, -50%) scaleX(-1);
    }

    .cell-wrapper input[type=range] {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 90%;
      opacity: 0.5;
      pointer-events:auto;
    }

    .cell-wrapper .label {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 90%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <h1>AIRmatic level custom offset</h1>

  <!-- Mode blocks -->
  <div class="mode-block" data-mode="comfort">
    <h2>
      Comfort
      <button class="offset-btn" onclick="saveOffset('comfort')" style="display:none;">Save</button>
    </h2>
    <table class="level-table" style="display:none;">
      <tr>
        <td>(VR) front right</td>
        <td>(HR) rear right</td>
      </tr>
      <tr>
        <td class="fzgn_vr"><span class="value">-</span> <span class="unit">mm</span></td>
        <td class="fzgn_hr"><span class="value">-</span> <span class="unit">mm</span></td>
      </tr>
      <tr>
        <td class="fzgn_vl"><span class="value">-</span> <span class="unit">mm</span></td>
        <td class="fzgn_hl"><span class="value">-</span> <span class="unit">mm</span></td>
      </tr>
      <tr>
        <td>(VL) front left</td>
        <td>(HL) rear left</td>
      </tr>
    </table>

    <!-- 2D Canvas Scene -->
    <iframe src="two-js.html"></iframe>
 
    <table class="offset-table">
      <tr>
        <td class="input-cell">
          <div class="input-wrapper">
            <input type="number" id="comfort_offset_nv" disabled>
            <span class="unit">mm</span>
          </div>
        </td>
        <td class="input-cell">
          <div class="input-wrapper">
            <input type="number" id="comfort_offset_nh" disabled>
            <span class="unit">mm</span>
          </div>
        </td>
      </tr>
      <tr>
        <td class="cell-with-slider">
          <div class="cell-wrapper">
            <input class="reversed" type="range" id="slider_comfort_offset_nv" min="-50" max="50" step="1" value="0" style="display:none;">
            <div class="label">front axle level custom offset</div>
          </div>
        </td>
        <td class="cell-with-slider">
          <div class="cell-wrapper">
            <input class="reversed" type="range" id="slider_comfort_offset_nh" min="-50" max="50" step="1" value="0" style="display:none;">
            <div class="label">rear axle level custom offset</div>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <div class="mode-block" data-mode="sport1">
    <h2>
      Sport
      <button class="offset-btn" onclick="saveOffset('sport1')" style="display:none;">Save</button>
    </h2>
    <table class="level-table" style="display:none;">
      <tr>
        <td>(VR) front right</td>
        <td>(HR) rear right</td>
      </tr>
      <tr>
        <td class="fzgn_vr"><span class="value">-</span> <span class="unit">mm</span></td>
        <td class="fzgn_hr"><span class="value">-</span> <span class="unit">mm</span></td>
      </tr>
      <tr>
        <td class="fzgn_vl"><span class="value">-</span> <span class="unit">mm</span></td>
        <td class="fzgn_hl"><span class="value">-</span> <span class="unit">mm</span></td>
      </tr>
      <tr>
        <td>(VL) front left</td>
        <td>(HL) rear left</td>
      </tr>
    </table>

    <!-- 2D Canvas Scene -->
    <iframe src="two-js.html"></iframe>
 
    <table class="offset-table">
      <tr>
        <td class="input-cell">
          <div class="input-wrapper">
            <input type="number" id="sport1_offset_nv" disabled>
            <span class="unit">mm</span>
          </div>
        </td>
        <td class="input-cell">
          <div class="input-wrapper">
            <input type="number" id="sport1_offset_nh" disabled>
            <span class="unit">mm</span>
          </div>
        </td>
      </tr>
      <tr>
        <td class="cell-with-slider">
          <div class="cell-wrapper">
            <input class="reversed" type="range" id="slider_sport1_offset_nv" min="-50" max="50" step="1" value="0" style="display:none;">
            <div class="label">front axle level custom offset</div>
          </div>
        </td>
        <td class="cell-with-slider">
          <div class="cell-wrapper">
            <input class="reversed" type="range" id="slider_sport1_offset_nh" min="-50" max="50" step="1" value="0" style="display:none;">
            <div class="label">rear axle level custom offset</div>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <div class="mode-block" data-mode="sport2">
    <h2>
      Sport II
      <button class="offset-btn" onclick="saveOffset('sport2')" style="display:none;">Save</button>
    </h2>
    <table class="level-table" style="display:none;">
      <tr>
        <td>(VR) front right</td>
        <td>(HR) rear right</td>
      </tr>
      <tr>
        <td class="fzgn_vr"><span class="value">-</span> <span class="unit">mm</span></td>
        <td class="fzgn_hr"><span class="value">-</span> <span class="unit">mm</span></td>
      </tr>
      <tr>
        <td class="fzgn_vl"><span class="value">-</span> <span class="unit">mm</span></td>
        <td class="fzgn_hl"><span class="value">-</span> <span class="unit">mm</span></td>
      </tr>
      <tr>
        <td>(VL) front left</td>
        <td>(HL) rear left</td>
      </tr>
    </table>

    <!-- 2D Canvas Scene -->
    <iframe src="two-js.html"></iframe>
 
    <table class="offset-table">
      <tr>
        <td class="input-cell">
          <div class="input-wrapper">
            <input type="number" id="sport2_offset_nv" disabled>
            <span class="unit">mm</span>
          </div>
        </td>
        <td class="input-cell">
          <div class="input-wrapper">
            <input type="number" id="sport2_offset_nh" disabled>
            <span class="unit">mm</span>
          </div>
        </td>
      </tr>
      <tr>
        <td class="cell-with-slider">
          <div class="cell-wrapper">
            <input class="reversed" type="range" id="slider_sport2_offset_nv" min="-50" max="50" step="1" value="0" style="display:none;">
            <div class="label">front axle level custom offset</div>
          </div>
        </td>
        <td class="cell-with-slider">
          <div class="cell-wrapper">
            <input class="reversed" type="range" id="slider_sport2_offset_nh" min="-50" max="50" step="1" value="0" style="display:none;">
            <div class="label">rear axle level custom offset</div>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <div class="mode-block" data-mode="offroad">
    <h2>
      Offroad
      <button class="offset-btn" onclick="saveOffset('offroad')" style="display:none;">Save</button>
    </h2>
    <table class="level-table" style="display:none;">
      <tr>
        <td>(VR) front right</td>
        <td>(HR) rear right</td>
      </tr>
      <tr>
        <td class="fzgn_vr"><span class="value">-</span> <span class="unit">mm</span></td>
        <td class="fzgn_hr"><span class="value">-</span> <span class="unit">mm</span></td>
      </tr>
      <tr>
        <td class="fzgn_vl"><span class="value">-</span> <span class="unit">mm</span></td>
        <td class="fzgn_hl"><span class="value">-</span> <span class="unit">mm</span></td>
      </tr>
      <tr>
        <td>(VL) front left</td>
        <td>(HL) rear left</td>
      </tr>
    </table>

    <!-- 2D Canvas Scene -->
    <iframe src="two-js.html"></iframe>
 
    <table class="offset-table">
      <tr>
        <td class="input-cell">
          <div class="input-wrapper">
            <input type="number" id="offroad_offset_nv" disabled>
            <span class="unit">mm</span>
          </div>
        </td>
        <td class="input-cell">
          <div class="input-wrapper">
            <input type="number" id="offroad_offset_nh" disabled>
            <span class="unit">mm</span>
          </div>
        </td>
      </tr>
      <tr>
        <td class="cell-with-slider">
          <div class="cell-wrapper">
            <input class="reversed" type="range" id="slider_offroad_offset_nv" min="-50" max="50" step="1" value="0" style="display:none;">
            <div class="label">front axle level custom offset</div>
          </div>
        </td>
        <td class="cell-with-slider">
          <div class="cell-wrapper">
            <input class="reversed" type="range" id="slider_offroad_offset_nh" min="-50" max="50" step="1" value="0" style="display:none;">
            <div class="label">rear axle level custom offset</div>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <!-- Calibration block -->
  <div class="calibration-block">
    <h2>PWM Voltage Calibration (do not change!)</h2>
    <div class="button-row">
      <button onclick="readCalibration()">Reset</button>
      <button class="edit-btn" onclick="enableCalibration()">Edit</button>
      <button class="save-btn" onclick="saveCalibration()" style="display:none;">Save</button>
      <span id="warn-ico" style="display:none; font-size: 2.4em;">&#x26A0;&#xFE0F;</span>
    </div>
    <table>
      <tr>
        <td>(VR) front right</td>
        <td>(HR) rear right</td>
      </tr>
      <tr>
        <td>
          <div class="calibration-control">
            <span class="duty" id="duty_vr" style="display:inline-block;">-</span>
            <button class="inc-btn" onclick="incrementValue('calibration_calib_vr', -1)" style="display:none;">−</button>
            <input type="number" id="calibration_calib_vr" disabled>
            <button class="inc-btn" onclick="incrementValue('calibration_calib_vr', +1)" style="display:none;">+</button>
            <span class="duty" id="pct_vr" style="display:inline-block;">-</span>
          </div>
        </td>
        <td>
          <div class="calibration-control">
            <span class="duty" id="duty_hr" style="display:inline-block;">-</span>
            <button class="inc-btn" onclick="incrementValue('calibration_calib_hr', -1)" style="display:none;">−</button>
            <input type="number" id="calibration_calib_hr" disabled>
            <button class="inc-btn" onclick="incrementValue('calibration_calib_hr', +1)" style="display:none;">+</button>
            <span class="duty" id="pct_hr" style="display:inline-block;">-</span>
          </div>
        </td>
      </tr>
      <tr>
        <td>
          <div class="calibration-control">
            <span class="duty" id="duty_vl" style="display:inline-block;">-</span>
            <button class="inc-btn" onclick="incrementValue('calibration_calib_vl', -1)" style="display:none;">−</button>
            <input type="number" id="calibration_calib_vl" disabled>
            <button class="inc-btn" onclick="incrementValue('calibration_calib_vl', +1)" style="display:none;">+</button>
            <span class="duty" id="pct_vl" style="display:inline-block;">-</span>
          </div>
        </td>
        <td>
          <div class="calibration-control">
            <span class="duty" id="duty_hl" style="display:inline-block;">-</span>
            <button class="inc-btn" onclick="incrementValue('calibration_calib_hl', -1)" style="display:none;">−</button>
            <input type="number" id="calibration_calib_hl" disabled>
            <button class="inc-btn" onclick="incrementValue('calibration_calib_hl', +1)" style="display:none;">+</button>
            <span class="duty" id="pct_hl" style="display:inline-block;">-</span>
          </div>
        </td>
      </tr>
      <tr>
        <td>(VL) front left</td>
        <td>(HL) rear left</td>
      </tr>
    </table>
  </div>

<script>
  let cachedJson = {};
  let lastFocused = null;
  let currentMode = null;
 
  // additional offset for 2D rendering animation (mm)
  const offset = {
    comfort: { nv:   0, nh:   0 },
    sport1:  { nv: -10, nh: -10 },
    sport2:  { nv: -15, nh: -15 },
    offroad: { nv:  25, nh:  25 }
  };

  document.addEventListener('focusin', (event) => {
    if (event.target.tagName === 'INPUT') {
      lastFocused = event.target.id;
    }
  });

  document.addEventListener('focusout', (event) => {
    if (event.target.tagName === 'INPUT') {
      handleFieldUpdate(event.target);
      lastFocused = null;
    }
  });
  
  function incrementValue(id, delta) {
    const field = document.getElementById(id);
    if (!field) return;
    let val = parseInt(field.value);
    if (isNaN(val)) val = 0;
    val += delta;
    field.value = val;
    handleFieldUpdate(field);
  }

  function handleFieldUpdate(activeField) {
    const id = activeField.id;
    let val = parseInt(activeField.value);
    if (isNaN(val)) val = 0;
    if (id.startsWith("calibration_")) {
      const key = id.replace("calibration_", "");
      if (!cachedJson.calibration) cachedJson.calibration = {};
      if ("duty" in cachedJson.calibration) {
        const duty = cachedJson.calibration.duty;
        if (val < -duty) val = -duty;
        if (val > duty) val = duty;
        activeField.value = val;
      }
      const oldVal = cachedJson.calibration[key];
      if (oldVal !== val) {
        cachedJson.calibration[key] = val;
        sendUpdatedJson();
      }
    } else {
      const parts = id.split("_");
      const mode = parts.shift();
      const key = parts.join("_");
      if (!cachedJson[mode]) cachedJson[mode] = {};
      const oldVal = cachedJson[mode][key];
      if (oldVal !== val) {
        cachedJson[mode][key] = val;
        sendUpdatedJson();
      }
    }
  }

  function initSliders() {
    const modes = ["offroad", "comfort", "sport1", "sport2"];
    modes.forEach(mode => {
      ["offset_nv", "offset_nh"].forEach(key => {
        const id = `${mode}_${key}`;
        const sliderId = `slider_${id}`;
        const input = document.getElementById(id);
        const slider = document.getElementById(sliderId);
        if (input && slider) {
          slider.addEventListener("input", () => {
            if (Number(input.value) !== Number(slider.value)) {
              input.focus();
              input.value = slider.value;
              syncCanvasWithInputs(mode);
            }
          });
          input.addEventListener("input", () => {
            if (Number(slider.value) !== Number(input.value)) {
              slider.value = input.value;
              syncCanvasWithInputs(mode);
            }
          });
        }
      });
    });
  }

  function syncCanvasWithInputs(mode) {
    const block = document.querySelector(`.mode-block[data-mode="${mode}"]`);
    if (!block) return;

    const iframe = block.querySelector("iframe");
    if (!iframe || !iframe.contentWindow) return;

    function doSync() {
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
      if (!iframeDoc) return;

      const nvInput = block.querySelector(`#${mode}_offset_nv`);
      const nhInput = block.querySelector(`#${mode}_offset_nh`);

      let frontVal = Number(nvInput.value);
      let rearVal  = Number(nhInput.value);

      // apply additional offset for 2D rendering animation (mm)
      if (offset[mode]) {
        frontVal += offset[mode].nv || 0;
        rearVal  += offset[mode].nh || 0;
      }

      const frontInput = iframeDoc.querySelector('input[name="front"]');
      const rearInput  = iframeDoc.querySelector('input[name="rear"]');

      if (frontInput) frontInput.value = frontVal;
      if (rearInput)  rearInput.value  = rearVal;

      if (typeof iframe.contentWindow._calcSlope === "function") {
        iframe.contentWindow._calcSlope();
      }
    }

    if (iframe.contentDocument?.readyState === "complete") {
      doSync();
    } else {
      iframe.onload = doSync;
    }
  }

  function enableSlider(mode, enable) {
    const sliders = document.querySelectorAll(`.mode-block[data-mode="${mode}"] input[type="range"]`);
    sliders.forEach(slider => {
      slider.style.display = enable ? 'block' : 'none';
    });
  }

  function enableButton(mode, enable) {
    const btn = document.querySelector(`.mode-block[data-mode="${mode}"] .offset-btn`);
    if (btn) {
      btn.style.display = enable ? 'inline-block' : 'none';
    }
  }

  function enableCurrentLevel(mode, enable) {
    const tbl = document.querySelector(`.mode-block[data-mode="${mode}"] .level-table`);
    if (tbl) {
      tbl.style.display = enable ? "table" : "none";
    }
  }

  function enableGearing(mode, enable) {
    const form = document.querySelector(`.mode-block[data-mode="${mode}"] iframe`)?.contentWindow?.document?.forms["gearing"];
    if (form) {
      if (enable) {
        form.elements["front"].disabled = false;
        form.elements["rear"].disabled  = false;
      } else {
        form.elements["front"].disabled = true;
        form.elements["rear"].disabled  = true;
      }
      form.style.display = "none";
    }
  }

  function enableCalibration() {
    document.querySelectorAll('.calibration-block input').forEach(el => el.disabled = false);
    document.querySelector('.edit-btn').style.display = "none";
    document.querySelector('.save-btn').style.display = "inline-block";
    document.getElementById('warn-ico').style.display = "inline";
    document.querySelectorAll('.inc-btn').forEach(btn => btn.style.display = "inline-block");
    document.querySelectorAll('.duty').forEach(span => span.style.display = "none");
  }

  function readCalibration() {
    document.querySelectorAll('.calibration-block input').forEach(el => el.disabled = true);
    document.querySelector('.edit-btn').style.display = "inline-block";
    document.querySelector('.save-btn').style.display = "none";
    document.getElementById('warn-ico').style.display = "none";
    document.querySelectorAll('.inc-btn').forEach(btn => btn.style.display = "none");
    document.querySelectorAll('.duty').forEach(span => span.style.display = "inline-block");
    fetch("/config?update=1", { method: "POST" })
      .then(() => setTimeout(fetchJson, 200));
  }

  function saveCalibration() {
    document.querySelectorAll('.calibration-block input').forEach(el => el.disabled = true);
    document.querySelector('.edit-btn').style.display = "inline-block";
    document.querySelector('.save-btn').style.display = "none";
    document.getElementById('warn-ico').style.display = "none";
    document.querySelectorAll('.inc-btn').forEach(btn => btn.style.display = "none");
    document.querySelectorAll('.duty').forEach(span => span.style.display = "inline-block");
    fetch("/config?update=2", { method: "POST" })
  }

  function sendUpdatedJson() {
    fetch("/config?update=3", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(cachedJson)
    });
  }

  function saveOffset(mode) {
    fetch("/config?update=4", { method: "POST" })
  }

  function fetchJson() {
    fetch("/config.json")
      .then(response => response.json())
      .then(data => {
        cachedJson = data;
        if ("current_mode" in data) {
          currentMode = data.current_mode;
        } else {
          currentMode = null;
        }
        updateUI();
      });
  }

  function updateUI() {
    let cur_offset_v = 0;
    let cur_offset_h = 0;
    const cal = cachedJson["calibration"] || {};
    ["calib_vl", "calib_vr", "calib_hl", "calib_hr"].forEach(key => {
      const id = "calibration_" + key;
      if (document.activeElement.id !== id) {
        const el = document.getElementById(id);
        if (el && key in cal) el.value = cal[key];
      }
    });
    if ("duty" in cal) {
      ["vl", "vr", "hl", "hr"].forEach(side => {
        const calibKey = "calib_" + side;
        if (!(calibKey in cal)) return;
        const dutyVal = cal.duty + cal[calibKey];
        const pctVal = (dutyVal * 100 / 255).toFixed(0) + " %";
        const dutyEl = document.getElementById("duty_" + side);
        const pctEl  = document.getElementById("pct_" + side);
        if (dutyEl) dutyEl.textContent = dutyVal;
        if (pctEl)  pctEl.textContent  = pctVal;
      });
    }
    const modes = ["offroad", "comfort", "sport1", "sport2"];
    modes.forEach(mode => {
      const data = cachedJson[mode];
      if (!data) return;
      ["offset_nv", "offset_nh"].forEach(key => {
        const id = `${mode}_${key}`;
        const el = document.getElementById(id);
        if (!el) return;
        if (mode === currentMode) {
          enableSlider(mode, true);
          enableButton(mode, true);
          enableCurrentLevel(mode, true);
          enableGearing(mode, true);
          el.disabled = false;
          if (document.activeElement.id !== id && key in data) el.value = data[key];
          if (key === "offset_nv" && key in data) cur_offset_v = Number(data[key]);
          if (key === "offset_nh" && key in data) cur_offset_h = Number(data[key]);
        } else {
          enableSlider(mode, false);
          enableButton(mode, false);
          enableCurrentLevel(mode, false);
          enableGearing(mode, false);
          el.disabled = true;
          if (key in data) el.value = data[key];
        }
        syncCanvasWithInputs(mode);
      });
    });
    const level = cachedJson["level"] || {};
    if (Object.keys(level).length) {
      ["fzgn_vl", "fzgn_vr", "fzgn_hl", "fzgn_hr"].forEach(key => {
        document.querySelectorAll(`.${key} .value`).forEach(el => {
          el.textContent = (key in level)
            ? level[key] - 127 + (key.includes("_v") ? cur_offset_v : cur_offset_h)
            : "-";
        });
      });
    }
  }

  fetchJson();
  initSliders();
  setInterval(fetchJson, 2000);
</script>

</body>
</html>
