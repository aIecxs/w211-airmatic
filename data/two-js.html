<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Lowrider</title>
    <script src="./two.min.js"></script>  <!-- 2D rendering engine by Jono (@jonobr1) -->
    <script src="./gsap.min.js"></script> <!-- GreenSock Animation Platform by Jack Doyle (@jackdoyle) -->
    <style>
      canvas {
        border: 1px solid #333;
        background: #fff;
      }
      .mmInput {
        width: 4rem;
      }
    </style>
  </head>
  <body>
    <canvas id="scene" width="808" height="316"></canvas>

    <script>
      function deg2rad(deg) {
        return deg * (Math.PI / 180);
      }

      const elem = document.getElementById('scene');
      const two = new Two({
        width: 808,
        height: 316,
        domElement: elem,
        type: Two.Types.canvas
      }).appendTo(elem.parentNode);

      // ----- Wheels -----
      const frontWheel = two.makeSprite("./wheel.png", 165, 200);
      const rearWheel = frontWheel.clone(two);
      rearWheel.translation.set(594, 200);

      // ----- Chassis -----
      const chassis = two.makeSprite('./chassis.png', 404, 158);

      // ----- Wheel Mount Recess -----
      const chassisBg = two.makeRectangle(chassis.position.x, chassis.position.y, 550, 75);
      chassisBg.fill = '#333332'; // dark gray
      chassisBg.noStroke();

      // Define offset: 25px left, 21px down
      const rectOffset = new Two.Vector(-25, 21);

      // Draw order: rectangle -> wheels -> chassis
      two.scene.add(chassisBg);
      two.scene.add(frontWheel, rearWheel);
      two.scene.add(chassis);

      const chassisOrigin = chassis.position.clone();

      two.play();

      // Make rectangle follow chassis with offset
      two.bind('update', () => {
        chassisBg.position.set(
          chassis.position.x + rectOffset.x,
          chassis.position.y + rectOffset.y
        );
        chassisBg.rotation = chassis.rotation;
      });

      function mm2px(mm) {
        return mm / 3;
      }

      function px2mm(px) {
        return px * 3;
      }

      function _gear(rad, offset) {
        const y = chassisOrigin.y - offset;

        // Rotate chassis
        const rotationTween = gsap.to(chassis, {
          rotation: rad,
          duration: 1,
          ease: "power2.inOut",
          paused: true
        });
        rotationTween.play();

        // Vertical translation of chassis
        const transTween = gsap.to(chassis.translation, {
          y: y,
          duration: 1,
          ease: "power2.inOut",
          paused: true
        });
        transTween.play();
      }

      function _calcSlope() {
        const form = document.forms.namedItem("gearing");
        const frontInput = form.elements.namedItem("front");
        const rearInput = form.elements.namedItem("rear");

        const frontHeight = frontInput.value;
        const rearHeight = rearInput.value;

        const axisWidth = px2mm(rearWheel.translation.x - frontWheel.translation.x);
        const slopeAngle = (frontHeight - rearHeight) / axisWidth;
        const lowering = frontHeight - (slopeAngle * (axisWidth / 2));

        console.log(slopeAngle, lowering);

        const loweringPx = mm2px(lowering);
        _gear(slopeAngle, loweringPx);
      }
    </script>

    <form name="gearing">
      <label>Front (mm): <input type="number" name="front" value="0" onchange="_calcSlope()" class="mmInput"></label>
      <label>Rear (mm): <input type="number" name="rear" value="0" onchange="_calcSlope()" class="mmInput"></label>
    </form>
  </body>
</html>
